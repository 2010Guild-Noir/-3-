<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ä¿®ç¾…ç‹ä¸¸ æ°¸é ã®ç„¦åœŸãƒ‘ã‚ºãƒ«</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg-0:#070707; --ink:#f5f7fb; --muted:#a3a7b3; --line:#2b2e34; }
  body{ margin:0; color:var(--ink); font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
    background: radial-gradient(1400px 680px at 50% -10%, #1b1c20 0%, #0c0c0e 55%, var(--bg-0) 100%),
               linear-gradient(180deg, #0b0b0c 0%, #09090a 100%); min-height:100dvh; text-align:center; }
  .wrap{ max-width:640px; margin:22px auto 28px; padding:16px; }
  .panel{ margin:0 auto; padding:16px 14px; border-radius:16px; background:#121316; border:1px solid var(--line);
    box-shadow:0 18px 60px rgba(0,0,0,.55), 0 1px 0 rgba(255,255,255,.06) inset; backdrop-filter:saturate(120%) blur(8px); }
  /* ã‚¿ã‚¤ãƒˆãƒ«ã‚µã‚¤ã‚ºï¼B */
  h1{ font-size:22px; letter-spacing:.03em; margin:4px 0 2px; font-weight:700; }
  .subtitle{ font-size:12.5px; color:var(--muted); margin:0 0 10px; letter-spacing:.05em; }
  .hud{ display:flex; gap:10px; justify-content:space-between; align-items:center; margin:10px 0 6px; flex-wrap:wrap; }
  .badge{ background:linear-gradient(180deg,#1c1d22,#14151a); border:1px solid var(--line); border-radius:999px; padding:8px 14px; font-weight:700; }
  .rank-progress{ font-size:12px; font-weight:400; margin-left:8px; opacity:0.8; }
canvas{ max-width:480px; box-sizing:border-box; display:block; margin:18px auto; width:100%; height:auto; aspect-ratio:1/1; box-sizing:border-box; background:#111; border-radius:14px; border:1px solid var(--line);
   box-shadow:0 16px 40px rgba(0,0,0,.6), 0 1px 0 rgba(255,255,255,.05) inset; touch-action:none; }
 .panel{ overflow:hidden; } /* ã¯ã¿å‡ºã—ã‚’å·¦å³å‡ç­‰ã«ã‚¯ãƒªãƒƒãƒ— */
  .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:16px 0 12px; }
  .btn{ display:inline-flex; align-items:center; gap:.4em; font-weight:600; font-size:14px;
    background:linear-gradient(180deg,#202126,#14151a); color:#fff; border:1px solid var(--line);
    border-radius:999px; padding:8px 12px; cursor:pointer; user-select:none;
    box-shadow:0 1px 0 rgba(255,255,255,.06) inset, 0 10px 24px rgba(0,0,0,.35);
    transition:transform .08s ease, box-shadow .18s ease, border-color .2s ease, background .2s ease; }
  .btn:hover{ transform:translateY(-1px); border-color:#3c4048; box-shadow:0 14px 28px rgba(0,0,0,.44); }
  .btn:active{ transform:translateY(0); box-shadow:0 6px 14px rgba(0,0,0,.44) inset; }
  .btn-kanki{ background:linear-gradient(180deg,#233246,#17212c); border-color:#2b3b4f; }
  .btn-shodo{ background:linear-gradient(180deg,#3a1b1e,#1d0e10); border-color:#4b2a2f; }
  .btn.active{ outline:2px solid #7fb7ff; }
  .btn-shuffle{ background:linear-gradient(180deg,#44224a,#2c1430); border-color:#5c3563; }
  .btn-mini{ padding:4px 8px; font-size:12px; }
  .status{ margin:6px 0 10px; font-size:12.5px; color:var(--muted); }

  /* æ“ä½œæ–¹æ³•ï¼Bï¼ˆæ å†…ï¼‰ */
  details.help{ text-align:left; background:linear-gradient(180deg,#14151a,#111217); border:1px solid var(--line);
                border-radius:14px; padding:12px 14px; margin:14px 0; box-shadow:0 12px 32px rgba(0,0,0,.35) inset; }
  details.help summary{ cursor:pointer; font-weight:700; }
  details.help ul{ margin:8px 0 0 18px; } details.help li{ margin:4px 0; line-height:1.6; }
  small.note{ opacity:.75; display:block; margin-top:6px; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå›³é‘‘ï¼‰ï¼Aæœ¬ä½“ + ã‚¿ã‚°è¦‹ãŸç›®ã¯Bæº–æ‹  */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
  .modal-overlay.open { display: flex; }
  .char-modal-content { background:#191b1f; padding:25px; border-radius:12px; max-width:90%; max-height:80%; overflow-y:auto; position:relative; color:var(--ink); text-align:left; border:1px solid var(--line); box-shadow:0 12px 30px rgba(0,0,0,0.6); }
  .close-btn { position:absolute; top:10px; right:15px; font-size:28px; font-weight:bold; cursor:pointer; color:var(--muted); }
  .char-list { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:15px;margin-top:20px; }
  .char-item { border:1px solid #333; padding:10px; border-radius:8px; background:#222; opacity:5; transition:opacity .3s; }
  .char-item.unlocked{ opacity:1; }
  .char-item h4 { margin:0 0 5px 0; font-size:16px; }
  .char-item p { margin:0; font:12px; color:var(--muted); }
  .char-item img { width:40px; height:40px; margin-right:10px; border-radius:4px; vertical-align:middle; }
  .char-item .title-row { display:flex; align-items:center; }

  /* å›³é‘‘ã®ã‚¿ã‚°ï¼ˆBæº–æ‹ ã®ã‚µã‚¤ã‚º/é›°å›²æ°— + æŒ‡å®šè‰²ï¼‰ */
  .char-tag{ display:inline-block; font-size:10px; padding:3px 6px; border-radius:4px; font-weight:700; border:1px solid #444; margin-left:6px; }
  .char-tag.yellow{ background:#4d4200; border-color:#6b5e00; color:#ffd900; } /* åˆæ­“=é»„è‰² */
  .char-tag.blue  { background:#0c2a4a; border-color:#174a7a; color:#7fc8ff; } /* è¾°åéƒ=é’ */
  .char-tag.red   { background:#3a0c12; border-color:#5a1c22; color:#ff8a8a; } /* ãƒ—ãƒ­ãƒ‘ã‚¬ãƒ³ãƒ€=èµ¤ */
  .char-tag.neutral{ background:#333; color:#ccc; }
  /* ç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯ = ã‚ªãƒ¬ãƒ³ã‚¸ï¼‹é»’ç³» */
  .char-tag.orange{ background:#4a2a00; border-color:#6a3a00; color:#ffb25f; }

  /* æœ€çµ‚ãƒ©ãƒ³ã‚¯æ™‚ï¼šç‰¹æ®Šé¸æŠè¡Œã®ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ */
  #rankSelectRow .btn-icon{
    display:inline-flex; align-items:center; gap:4px; padding:2px 4px; border-radius:10px;
    font-size:12px; line-height:0; border:1px solid var(--line); background:linear-gradient(180deg,#222,#16171b);
  }
/* ç‰¹æ®Šé¸æŠãƒœã‚¿ãƒ³åŒå£«ã®é–“éš”ã‚’åºƒã’ã‚‹ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºã‚„æ ã‚µã‚¤ã‚ºã¯ãã®ã¾ã¾ï¼‰ */
#rankSelectRow { 
  gap: 14px;         /* â† ã“ã“ã§ãƒœã‚¿ãƒ³é–“ã‚’åºƒã’ã¾ã™ï¼ˆãŠå¥½ã¿ã§14ã€œ20ã«èª¿æ•´å¯ï¼‰ */
}
  #rankSelectRow .btn-icon img{ width:40px; height:40px; border-radius:3px; display:block; } /* ç‰¹æ®Šã‚¢ã‚¤ã‚³ãƒ³ã ã‘å°‘ã—æ‹¡å¤§ */
  #rankSelectRow .btn-icon.active{ outline:2px solid #7fb7ff; }

/* ãƒ‘ãƒãƒ«å¤–ã¸æç”»ãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
.panel{ overflow: hidden; }

/* é€£ç¶šã™ã‚‹ãƒœã‚¿ãƒ³è¡Œã®é–“ã‚’åºƒã‚ã« */
.panel > .row + .row { margin-top: 10px; }
/* ç›¤é¢ä»¥å¤–ã®ãƒœã‚¿ãƒ³è¡Œã¯å·¦å³ã«åºƒã’ã¤ã¤ã€é–“éš”ã‚‚å°‘ã—åºƒã‚ï¼ˆå‰å›ã®æŒ‡å®šã‚’ä¸Šæ›¸ãï¼‰ */
.panel > .row:not(#rankSelectRow) {
  justify-content: center; /* â† or flex-startã€‚space-between ã‚’ã‚„ã‚ã‚‹ */
  gap: 12px;               /* ãŠå¥½ã¿ã®ç‹­ã•ã«èª¿æ•´ */
  width: 100%;
}
details.help summary,
details.help ul,
details.help li {
  text-align: left;
}


/* === MAX Reset UI === */
#maxResetBtn{position:fixed;top:10px;right:10px;width:28px;height:28px;border-radius:9999px;border:1px solid var(--line);background:rgba(20,20,20,.85);color:var(--text);font-size:11px;line-height:28px;text-align:center;cursor:pointer;opacity:.85;display:none;z-index:9999;}
#maxResetBtn:hover{opacity:1;}
#maxResetConfirm{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:10000;}
#maxResetConfirm .panel{background:#111;border:1px solid var(--line);border-radius:12px;padding:14px 16px;max-width:88vw;box-shadow:0 10px 28px rgba(0,0,0,.6);}
#maxResetConfirm .title{font-size:14px;margin-bottom:10px;}
#maxResetConfirm .cmds{display:flex;gap:10px;justify-content:flex-end;margin-top:8px;}
#maxResetConfirm .cmds button{font-size:13px;padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#1c1c1c;color:var(--text);cursor:pointer;}
#maxResetConfirm .cmds button.primary{background:#2a2a2a;}

</style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>ä¿®ç¾…ç‹ä¸¸ æ°¸é ã®ç„¦åœŸãƒ‘ã‚ºãƒ«</h1>
      <p class="subtitle">3ã¤ãã‚ãˆã‚‹ã¨æ¶ˆãˆã‚‹â€”çµ‚ã‚ã‚Šãªãæ¶ˆå»ã¨æš—èº</p>

      <div class="hud">
        <div class="badge" id="score">æš—èºå€¤: 0</div> <!-- Lvè¡¨ç¤ºã¯å‰Šé™¤ï¼ˆBï¼‰ -->
        <div class="badge" id="rank">ä¿®ç¾…ç‹ä¸¸: ãƒãƒ¼ã‚¹ <span class="rank-progress" id="rankProgress"></span></div>
      </div>

      <canvas id="gameCanvas"></canvas>
      <!-- â˜…æœ€çµ‚ãƒ©ãƒ³ã‚¯æ™‚ã®ã¿è¡¨ç¤ºï¼šç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯é¸æŠè¡Œ -->
      <div class="row" id="rankSelectRow" style="display:none;"></div>

      <!-- ãƒœã‚¿ãƒ³åˆ—ï¼A -->
      <div class="row">
        <button class="btn btn-kanki" id="btnKanki" onclick="setMode('kanki'); userGesture()">æ­“å–œ</button>
        <button class="btn btn-shodo" id="btnShodo" onclick="setMode('shodo'); userGesture()">ç„¦åœŸ</button>
        <button class="btn" id="pauseBtn" onclick="togglePause()">â¸ ä¸€æ™‚åœæ­¢</button>
        <button class="btn" id="btnCharIntro">ğŸ‘¤ ã‚­ãƒ£ãƒ©å›³é‘‘</button>
      </div>
      <div class="row">
        <button class="btn btn-mini" id="bgmSel1">â™ª1</button>
        <button class="btn btn-mini" id="bgmSel2">â™ª2</button>
        <button class="btn" id="bgmBtn" onclick="toggleBGM()">â™ª BGM ON</button>
        <button class="btn" id="seBtn"  onclick="toggleSE()">ğŸ”Š SE ON</button>
      </div>

      <div class="status" id="status">status: ready</div>

      <!-- æ“ä½œæ–¹æ³•ï¼B -->
      <details class="help" open>
        <summary>æ“ä½œæ–¹æ³•ï¼ˆPCï¼ã‚¹ãƒãƒ›ï¼‰</summary>
        <ul>
          <li><b>å…¥ã‚Œæ›¿ãˆï¼šãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼ã‚¹ãƒ¯ã‚¤ãƒ—ã§ä¸Šä¸‹å·¦å³ã®éš£ã¸ã€‚<br>â€ƒç¸¦/æ¨ªã«3ã¤ä»¥ä¸Šæƒãˆã‚‹ã¨æ¶ˆå»ã—ã¾ã™ã€‚</li>
          <li><b>æš—èºå€¤ï¼šãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¶ˆå»ã™ã‚‹ã¨æš—èºå€¤(ã‚¹ã‚³ã‚¢)ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚<br>â€ƒä¸­æ–­ã—ã¦ã‚‚ã‚¹ã‚³ã‚¢ã¯å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚</li>
          <li><b>ä¿®ç¾…ç‹ä¸¸ï¼šä¿®ç¾…ç‹ä¸¸ã‚’å¿…è¦æ•°æ¶ˆå»ã™ã‚‹ã¨è¦šé†’(ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—)ã—ã¾ã™ã€‚<br>â€ƒè¦šé†’æœ€é«˜å€¤å¾Œã¯æ°¸é ã®æš—èºã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚</li>
        </ul>
<small class="note">â€ƒâš è©°ã‚“ã§ã—ã¾ã£ãŸã‚‰ä¸€åº¦ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚ç›¤é¢ãŒã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚Œã¾ã™ã€‚</small>
      </details>

      <small class="note">â’¸ 2010 Guild Noir. ã€€ä¿®ç¾…ç‹ä¸¸Â®</small>

      <!-- å›³é‘‘ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼Aï¼ˆã‚¿ã‚°ã¯Bé¢¨ï¼‰ -->
      <div id="char-modal" class="modal-overlay" onclick="if(event.target.id === 'char-modal') closeCharModal()">
        <div class="char-modal-content">
          <span class="close-btn" onclick="closeCharModal()">&times;</span>
          <h2>ğŸ‘¤ ä¿®ç¾…ç‹ä¸¸ é¡•ç¾å›³é‘‘</h2>
          <div id="char-list" class="char-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- audioï¼šéŸ³ã¯Aã®æ§‹æˆ / ã‚¯ãƒªãƒƒã‚¯éŸ³ se_push / shineã¯åˆ¥ç”¨é€”ã«æ¸©å­˜ -->
  <audio id="bgm1" src="audio/bgm1.mp3" loop preload="auto"></audio>
  <audio id="bgm2" src="audio/bgm2.mp3" loop preload="auto"></audio>
  <audio id="se_vertical"   src="audio/se_vertical.mp3"   preload="auto"></audio>
  <audio id="se_horizontal" src="audio/se_horizontal.mp3" preload="auto"></audio>
  <audio id="se_circle"     src="audio/se_circle.mp3"     preload="auto"></audio>
  <audio id="se_cross"      src="audio/se_cross.mp3" preload="auto"></audio>
  <audio id="se_pop"        src="audio/se_pop.mp3"        preload="auto"></audio>
  <audio id="se_whoosh"     src="audio/se_whoosh.mp3" preload="auto"></audio>
  <audio id="se_shine"      src="audio/se_shine.mp3"  preload="auto"></audio>
  <audio id="se_push"       src="audio/se_push.mp3"   preload="auto"></audio> <!-- ãƒœã‚¿ãƒ³æ“ä½œéŸ³ -->
  <audio id="se_bell"       src="audio/se_bell.mp3"    preload="auto"></audio>
  <audio id="se_rumble"     src="audio/se_rumble.mp3"  preload="auto"></audio>
  <audio id="vo_rank0" src="audio/vo_rank0.mp3" preload="auto"></audio>
  <audio id="vo_rank1" src="audio/vo_rank1.mp3" preload="auto"></audio>
  <audio id="vo_rank2" src="audio/vo_rank2.mp3" preload="auto"></audio>
  <audio id="vo_rank3" src="audio/vo_rank3.mp3" preload="auto"></audio>
  <audio id="vo_rank4" src="audio/vo_rank4.mp3" preload="auto"></audio>
  <audio id="vo_shuffle" src="audio/vo_shuffle.mp3" preload="auto"></audio>

<script>
"use strict";

/* ===== æ°¸ç¶šåŒ–ï¼ˆAï¼‰ ===== */
const store = { get(k,d){try{const v=localStorage.getItem(k);return v===null?d:JSON.parse(v);}catch(_){return d}}, set(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(_){}} };

/* ===== ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆAï¼šBGM2ç³»çµ±ï¼‹SEãƒ—ãƒ¼ãƒ«ï¼‰ ===== */
const bgm1 = document.getElementById("bgm1");
const bgm2 = document.getElementById("bgm2");
let activeBGM = store.get("activeBGM", 1) === 2 ? bgm2 : bgm1;
let bgmOn = !!store.get("bgmOn", false);

const bgmBtn = document.getElementById("bgmBtn");
const bgmSel1 = document.getElementById("bgmSel1");
const bgmSel2 = document.getElementById("bgmSel2");
const seBtn  = document.getElementById("seBtn");

const BGM_DEFAULT_VOL = 0.35;
const SE_DEFAULT_VOL  = 0.25;

function makePool(a,n){ const arr=[a]; for(let i=1;i<n;i++) arr.push(a.cloneNode(true)); let idx=0;
  return { play(v){ const e=arr[idx++%arr.length]; try{e.pause();e.currentTime=0;}catch(_){}
    e.volume=v; e.play().catch(()=>{}); } };
}
const SE_BANK = {
  vertical:document.getElementById("se_vertical"),
  horizontal:document.getElementById("se_horizontal"),
  circle:document.getElementById("se_circle"),
  cross:document.getElementById("se_cross"),
  pop:document.getElementById("se_pop"),
  whoosh:document.getElementById("se_whoosh"),
  rumble:document.getElementById("se_rumble"),
  shine:document.getElementById("se_shine"),  // shineã¯åˆ¥ç”¨é€”ã®ã¾ã¾
  push:document.getElementById("se_push"),    // ãƒœã‚¿ãƒ³æ“ä½œéŸ³
  bell:document.getElementById("se_bell"),
  shuffle:document.getElementById("vo_shuffle"),
};
const Sound={ enabled:store.get("seOn", true), vol:store.get("seVol", SE_DEFAULT_VOL), pools:{},
  init(){ for(const k in SE_BANK){ if(SE_BANK[k]) this.pools[k]=makePool(SE_BANK[k],6); } },
  play(n, volMul=1){ if(!this.enabled) return; const p=this.pools[n]; if(p) p.play(this.vol*volMul); },
}; Sound.init();

function setBGMVol(v){ const nv=Number(v); bgm1.volume=nv; bgm2.volume=nv; store.set("bgmVol", nv); }
function setSEVol(v){ const nv=Number(v); Sound.vol=nv; store.set("seVol", nv); }
function toggleSE(){ Sound.enabled=!Sound.enabled; seBtn.textContent=Sound.enabled?"ğŸ”Š SE ON":"ğŸ”‡ SE OFF"; store.set("seOn", Sound.enabled); }

function pauseAllBGM(){ try{bgm1.pause();}catch(_){} try{bgm2.pause();}catch(_){} }
function currentBGM(){ return activeBGM===bgm2?bgm2:bgm1; }

function toggleBGM(){
  if(!bgmOn){
    pauseAllBGM(); currentBGM().currentTime = 0;
    currentBGM().play().catch(()=>{});
    bgmOn = true; bgmBtn.textContent="â™ª BGM OFF";
  }else{
    pauseAllBGM(); bgmOn = false; bgmBtn.textContent="â™ª BGM ON";
  }
  store.set("bgmOn", bgmOn);
}
function selectBGM(which){
  pauseAllBGM();
  activeBGM = (which===2)?bgm2:bgm1;
  store.set("activeBGM", which);
  setBGMVol(store.get("bgmVol", BGM_DEFAULT_VOL));
  activeBGM.currentTime = 0;
  activeBGM.play().then(()=>{ bgmOn=true; bgmBtn.textContent="â™ª BGM OFF"; store.set("bgmOn", true); }).catch(()=>{});
  bgmSel1.classList.toggle('active', which===1);
  bgmSel2.classList.toggle('active', which===2);
}

/* åˆå›ã‚¸ã‚§ã‚¹ãƒãƒ£ã§BGM/SEè§£ç¦ */
let audioUnlocked=false;
function unlockAllSE(){
  if(audioUnlocked) return;
  audioUnlocked=true;
  for(const k in SE_BANK){
    const a=SE_BANK[k]; if(!a) continue;
    try{ const v=a.volume; a.volume=0.0001; a.play().then(()=>{ a.pause(); a.currentTime=0; a.volume=v; }).catch(()=>{ a.volume=v; }); }catch(_){}
  }
}
function userGesture(){
  unlockAllSE();
// â˜…ã‚¿ãƒƒãƒ/ç§»å‹•ã§å¿…ãšBGMã‚’ã‚­ãƒƒã‚¯ï¼ˆåœæ­¢ä¸­ãªã‚‰å†ç”Ÿã—ã€çŠ¶æ…‹ã‚‚ONã¸ï¼‰
  if (currentBGM().paused){
    currentBGM().currentTime = 0;
    currentBGM().play()
      .then(()=>{
        bgmOn = true;
        bgmBtn.textContent = "â™ª BGM OFF";
        store.set("bgmOn", true);
      })
      .catch(()=>{});
  }
}
(function initAudio(){
  setBGMVol(store.get("bgmVol", BGM_DEFAULT_VOL));
  if(!Sound.enabled) seBtn.textContent="ğŸ”‡ SE OFF";
  const which=store.get("activeBGM",1);
  activeBGM = which===2?bgm2:bgm1;
  bgmSel1.classList.toggle('active', which===1);
  bgmSel2.classList.toggle('active', which===2);
  if(bgmOn){ currentBGM().play().then(()=>{ bgmBtn.textContent="â™ª BGM OFF"; }).catch(()=>{}); }
  else{ pauseAllBGM(); bgmBtn.textContent="â™ª BGM ON"; }
})();

/* ===== DOM & åŸºæœ¬è¨­å®šï¼ˆA åŸºæº–ï¼‰ ===== */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d", { alpha:true });
const $pauseBtn = document.getElementById("pauseBtn");
const $score = document.getElementById("score");
const $rank = document.getElementById("rank");
let $rankProgress = document.getElementById("rankProgress");
const $status = document.getElementById("status");
const $charModal = document.getElementById("char-modal");
const $charList = document.getElementById("char-list");

const size = 7;
let logicalSize = 400;
let tileSize = logicalSize/size;
let DPR = Math.max(1, Math.min(3, Math.floor(window.devicePixelRatio || 1)));
let paused = false;
let isKanki = true;
const DRAG_THRESHOLD = 0.35;

/* ===== ç”»åƒï¼ˆAï¼‰ ===== */
const IMG = {
  "SANZU": new Image(), "MUTSU": new Image(), "HANZO": new Image(), "CHIEKO": new Image(),
  "S_BIR": new Image(), "S_NE0": new Image(), "S_SHU": new Image(), "S_REQ": new Image(), "S_UNK": new Image(),
  "J_NEM": new Image(), "J_SHI": new Image(), "J_PRO": new Image(),
  "PATH_SANZU": "images/sanzu.png",
  "PATH_MUTSU": "images/mutsu.png",
  "PATH_HANZO": "images/hanzo.png",
  "PATH_CHIEKO": "images/chieko.png",
  "PATH_S_BIR": "images/special_bir.png",
  "PATH_S_NE0": "images/special_ne0.png",
  "PATH_S_SHU": "images/special_shu.png",
  "PATH_S_REQ": "images/special_req.png",
  "PATH_S_UNK": "images/special_unk.png",
  "PATH_J_NEM": "images/nemu.png",
  "PATH_J_SHI": "images/shinjuro.png",
  "PATH_J_PRO": "images/propaganda.png",
  "BG": new Image(), "PATH_BG": "images/boad_bg.png"
};
function loadImages(done){
  let loaded=0; const keys=Object.keys(IMG).filter(k=>!k.startsWith('PATH_')); const total=keys.length;
  if(total===0){ done(); return; }
  keys.forEach(k=>{ IMG[k].onload=()=>{ if(++loaded===total) done(); }; IMG[k].onerror=()=>{ if(++loaded===total) done(); };
    const p=IMG["PATH_"+k]; if(p) IMG[k].src=p; });
}

/* ===== ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›³é‘‘ ===== */
const CHARACTERS = [
  { sym: "CHIEKO", name: "ãƒã‚¨ã‚³", tag: "é€šå¸¸", desc: "ä¿®ç¾…ç‹ä¸¸ã®æœ€å¤ã®å¼ç¥ã€‚åŸºç¤çš„ãªæš—èºã‚’æ‹…ã†ã€‚", image: "CHIEKO", unlock: { key: "initial" } },
  { sym: "SANZU", name: "ä¸‰é€”", tag: "é€šå¸¸", desc: "ä¿®ç¾…ç‹ä¸¸ã®çŸ›ãŸã‚‹å¼ç¥ã€‚åŸºç¤çš„ãªæš—èºã‚’æ‹…ã†ã€‚", image: "SANZU", unlock: { key: "initial" } },
  { sym: "HANZO", name: "ãƒãƒ³ã‚¾ã‚¦", tag: "é€šå¸¸", desc: "ä¿®ç¾…ç‹ä¸¸ã®é§’ãŸã‚‹å¼ç¥ã€‚åŸºç¤çš„ãªæš—èºã‚’æ‹…ã†ã€‚", image: "HANZO", unlock: { key: "initial" } },
  { sym: "MUTSU", name: "é™¸å¥¥æ€ªç«¥", tag: "é€šå¸¸", desc: "ä¿®ç¾…ç‹ä¸¸ã®æ‰‹è¶³ãŸã‚‹å¼ç¥ã€‚åŸºç¤çš„ãªæš—èºã‚’æ‹…ã†ã€‚", image: "MUTSU", unlock: { key: "initial" } },

  { sym: "S_BIR", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ãƒãƒ¼ã‚¹", tag: "ç‰¹æ®Š", desc: "ä¿®ç¾…ç‹ä¸¸ã®æœ€åˆã®å§¿ã€‚ç¸¦åˆ—ã‚’æ¶ˆå»ã™ã‚‹ã€‚", image: "S_BIR", unlock: { key: "initial" } },
  { sym: "S_NE0", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ãƒã‚ªãƒ¬ãƒˆãƒ­", tag: "ç‰¹æ®Š", desc: "äººã®å§¿ã‚’æ¨ã¦ãŸä¿®ç¾…ç‹ä¸¸ã®å§¿ã€‚ç¸¦åˆ—æ¶ˆå»ï¼ˆåå­—å¼·åŒ–ãƒ¢ãƒ¼ãƒ‰ã§ç¸¦åˆ—+ä¸¡éš£ï¼‰ã€‚", image: "S_NE0", unlock: { key: "rank", value: 1 } },
  { sym: "S_SHU", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ã—ã‚…ã‚‰ã¡ã‚ƒã‚“", tag: "ç‰¹æ®Š", desc: "ãƒã‚ªãƒ¬ãƒˆãƒ­ã‚’åˆ‡ã‚Šæ¨ã¦ç”Ÿã¾ã‚ŒãŸå­˜åœ¨ã€‚åºƒç¯„å›²ã‚’å††å½¢ã«æ¶ˆå»ã™ã‚‹ã€‚", image: "S_SHU", unlock: { key: "rank", value: 2 } },
  { sym: "S_REQ", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ãƒ¬ã‚¯ã‚¤ã‚¨ãƒ ", tag: "ç‰¹æ®Š", desc: "æ–°ãŸãªå¢ƒåœ°ã‚’æ±‚ã‚ã¦ç”Ÿã¾ã‚ŒãŸå­˜åœ¨ã€‚æ¨ªåˆ—æ¶ˆå»ï¼ˆåå­—å¼·åŒ–ãƒ¢ãƒ¼ãƒ‰ã§æ¨ªåˆ—+ä¸Šä¸‹éš£ï¼‰ã€‚", image: "S_REQ", unlock: { key: "rank", value: 3 } },
  { sym: "S_UNK", name: "ä¿®ç¾…ç‹ä¸¸ãƒ»ã‚¢ãƒ³ãƒã‚¦ãƒ³", tag: "ç‰¹æ®Š", desc: "æœªã è¦‹ã¬å…ˆã®å¢ƒåœ°ã€‚æ–œã‚åˆ—ã‚’æ¶ˆå»ã™ã‚‹ï¼ˆåˆ‡ã‚Šæ›¿ãˆå¯èƒ½ï¼‰ã€‚", image: "S_UNK", unlock: { key: "rank", value: 4 } },

  { sym: "J_NEM", name: "åˆæ­“", tag: "å‘ªè©›", desc: "ä¿®ç¾…ç‹ä¸¸ã‚’æ¨ã‚€å¨˜ã€‚éš£æ¥ã™ã‚‹æ¶ˆå»ã§HPã‚’å‰Šã‚‹ã€‚HP:1ã€‚", image: "J_NEM", unlock: { key: "juso_spawn", value: true } },
  { sym: "J_SHI", name: "è¾°åéƒ", tag: "æ‚”æ¨", desc: "ç­‘å‰å¿å…«å‰£è¡†ã®å‰å…ƒç· ã€‚éš£æ¥ã™ã‚‹æ¶ˆå»ã§HPã‚’å‰Šã‚‹ã€‚HP:3ã€‚", image: "J_SHI", unlock: { key: "juso_spawn", value: true } },
  { sym: "J_PRO", name: "ãƒ—ãƒ­ãƒ‘ã‚¬ãƒ³ãƒ€", tag: "è„…å¨", desc: "é¡å†™ã—ã®ä¸–ç•Œã«ä½ã‚€æ­£ç¾©ã®ä¿®ç¾…ç‹ä¸¸ã€‚éš£æ¥ã™ã‚‹æ¶ˆå»ã§HPã‚’å‰Šã‚‹ã€‚HP:5ã€‚", image: "J_PRO", unlock: { key: "juso_spawn", value: true } },
];
let unlockedChars = store.get("unlockedChars", { initial: true, juso_spawn: false });

function tagClassByChar(ch){
  // ç‰¹æ®Šï¼ˆSPECIALS é…åˆ—ã«å«ã¾ã‚Œã‚‹ï¼‰
  if (Array.isArray(SPECIALS) && SPECIALS.includes(ch.sym)) return "orange";
  // ãŠé‚ªé­”3ç¨®ï¼ˆåˆæ­“ãƒ»è¾°åéƒãƒ»ãƒ—ãƒ­ãƒ‘ã‚¬ãƒ³ãƒ€ï¼‰
  if (ch.sym === "J_NEM" || ch.sym === "J_SHI" || ch.sym === "J_PRO") return "red";
  // é€šå¸¸
  return "neutral";
}
function updateCharModalContent(){
  if(!$charList) return; let html="";
  CHARACTERS.forEach(ch=>{
    let locked=false, note="";
    if(ch.unlock.key==="rank" && rankIndex<ch.unlock.value){ locked=true; note=`Rank ${ch.unlock.value} ã§è§£æ”¾`; }
    else if(ch.unlock.key==="juso_spawn" && !unlockedChars.juso_spawn){ locked=true; note=`å‘ªè©›ãƒ–ãƒ­ãƒƒã‚¯ã®å‡ºç¾ã§è§£æ”¾`; }
    const src = IMG["PATH_"+(ch.image||ch.sym)] || "";
    const tagHtml = `<span class="char-tag ${tagClassByChar(ch)}">${ch.tag}</span>`;
    html += `<div class="char-item ${locked?'locked':'unlocked'}">
      <div class="title-row"><img src="${src}" onerror="this.style.display='none';" alt="">
        <h4>${ch.name} ${tagHtml}</h4>
      </div>
      <p>${ch.desc}</p>${locked?`<small>${note}</small>`:''}
    </div>`;
  });
  $charList.innerHTML=html;
}
function openCharModal(){ if(!paused) togglePause(); updateCharModalContent(); $charModal.classList.add("open"); }
function closeCharModal(){ $charModal.classList.remove("open"); if(paused) togglePause(); }

/* ===== ãƒ©ãƒ³ã‚¯ãƒ»ç¨®åˆ¥ï¼ˆAï¼‰ ===== */
const RANKS = [
  { key:"S_BIR", name:"ãƒãƒ¼ã‚¹", score: 100 },
  { key:"S_NE0", name:"ãƒã‚ªãƒ¬ãƒˆãƒ­", score: 200 },
  { key:"S_SHU", name:"ã—ã‚…ã‚‰ã¡ã‚ƒã‚“", score: 300 },
  { key:"S_REQ", name:"ãƒ¬ã‚¯ã‚¤ã‚¨ãƒ ", score: 400 },
  { key:"S_UNK", name:"ã‚¢ãƒ³ãƒã‚¦ãƒ³", score: 500 }
];
const MAX_RANK_INDEX = RANKS.length - 1;

let maxAchieved = !!store.get('maxAchieved');
let specialPerkUnlocked = !!store.get('specialPerkUnlocked');
const NORMALS=["SANZU","MUTSU","HANZO","CHIEKO"];
const SPECIALS=RANKS.map(r=>r.key);
const JUSOS=["J_NEM", "J_SHI", "J_PRO"];
const RANK_THRESH = [10, 15, 20, 25, 30];
const SPECIAL_POINTS = { "S_BIR": 20, "S_NE0": 30, "S_SHU": 40, "S_REQ": 50, "S_UNK": 60 };

let board=[], yAnim=[], score=store.get("score",0), rankIndex=store.get("rankIndex",0), rankProgress=store.get("rankProgress",0);
let slashes=[], particles=[]; // Bã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¦ç´ 
let vanishMask=null, vanishP=0, animState="idle";
let drag={active:false,start:null,t:null}, swapPair=null;
let jusoHP=[], currentObstacleCount=0;

/* === æœ€çµ‚ãƒ©ãƒ³ã‚¯ï¼šç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯é¸æŠ === */
let selectedSpecialOverride = null; // nullæ™‚ã¯é€šå¸¸ã®ãƒ©ãƒ³ã‚¯ä¾å­˜
function voiceForSpecial(sym){
  if(sym==="S_BIR") return document.getElementById("vo_rank0");
  if(sym==="S_NE0") return document.getElementById("vo_rank1");
  if(sym==="S_SHU") return document.getElementById("vo_rank2");
  if(sym==="S_REQ") return document.getElementById("vo_rank3");
  if(sym==="S_UNK") return document.getElementById("vo_rank4");
  return null;
}
// â˜…è¿½åŠ ï¼šå†ç”Ÿä¸­ã®ãƒ©ãƒ³ã‚¯ãƒœã‚¤ã‚¹ã‚’æ­¢ã‚ã‚‹
function stopAllRankVoices(){
  ["vo_rank1","vo_rank2","vo_rank3","vo_rank4"].forEach(id=>{
    const a = document.getElementById(id);
    if(a){ try{ a.pause(); a.currentTime = 0; }catch(_){} }
  });
}

function buildRankSelectButtons(){
  const row = document.getElementById('rankSelectRow');
  if(!row || row.dataset.built==="1") return;
  const specials = ["S_BIR","S_NE0","S_SHU","S_REQ","S_UNK"];
  specials.forEach(sym=>{
    const btn = document.createElement('button');
    btn.className = 'btn-icon';
    const img = document.createElement('img');
    img.src = IMG["PATH_"+sym] || "";
    img.alt = sym;
    btn.appendChild(img);
    btn.addEventListener('click', ()=>{
      if(rankIndex!==MAX_RANK_INDEX) return;
      selectedSpecialOverride = sym;
      [...row.children].forEach(el=>el.classList.remove('active'));
      btn.classList.add('active');

      stopAllRankVoices();              // â˜…è¿½åŠ ï¼šå‰ã®ãƒœã‚¤ã‚¹ã‚’åœæ­¢
      const v = voiceForSpecial(sym);
      if(v){ try{ v.currentTime=0; v.play().catch(()=>{}); }catch(_){} }

      Sound.play('push', .9);
    });
    row.appendChild(btn);
  });
  row.dataset.built="1";
}

function updateStatus(text){ if($status) $status.textContent=text; }
function updateScoresUI(){
  // æš—èºå€¤ï¼šBï¼ˆLvã¯å‡ºã•ãªã„ï¼‰
  $score.textContent = `æš—èºå€¤: ${score}`;
  // å³ä¸Šãƒ©ãƒ³ã‚¯ï¼ˆAï¼‰
  const label = `ä¿®ç¾…ç‹ä¸¸: ${RANKS[rankIndex].name} `;
  if ($rank.firstChild) $rank.firstChild.textContent = label; else $rank.textContent = label;
  $rankProgress = document.getElementById("rankProgress") || (()=>{
    const sp=document.createElement('span'); sp.className='rank-progress'; sp.id='rankProgress'; $rank.appendChild(sp); return sp;
  })();
  $rankProgress.textContent = rankIndex===MAX_RANK_INDEX ? 'MAX' : `(${rankProgress}/${RANK_THRESH[rankIndex]})`;
  // æœ€çµ‚ãƒ©ãƒ³ã‚¯ã§é¸æŠè¡Œã‚’è¡¨ç¤º
  const selRow = document.getElementById('rankSelectRow');
  if(selRow){
    if(rankIndex===MAX_RANK_INDEX){
      buildRankSelectButtons();
      selRow.style.display='';
    }else{
      selRow.style.display='none';
      selectedSpecialOverride=null;
      [...selRow.children].forEach(el=>el.classList.remove('active'));
    }
  }
  // æ°¸ç¶š
  store.set("score",score); store.set("rankIndex",rankIndex); store.set("rankProgress",rankProgress);

  try{ if(window.__gateMaxResetBtn) window.__gateMaxResetBtn(); }catch(_){ }
}

/* ===== ç›¤é¢ï¼ˆAï¼‰ ===== */
function get(r,c){ return (r>=0 && r<size && c>=0 && c<size) ? board[r][c] : null; }
function set(r,c,v){ if(r>=0 && r<size && c>=0 && c<size) board[r][c]=v; }
function swap(r1,c1,r2,c2){ [board[r1][c1],board[r2][c2]]=[board[r2][c2],board[r1][c1]]; }
function getInitialBlock(){ return NORMALS[Math.floor(Math.random()*NORMALS.length)]; }

function initBoard(){
  board = Array.from({length:size},()=>Array(size).fill(0));
  jusoHP= Array.from({length:size},()=>Array(size).fill(0));
  yAnim = Array.from({length:size},()=>Array(size).fill(0));
  yVel  = Array.from({length:size},()=>Array(size).fill(0)); /* â˜…ã‚¯ãƒƒã‚·ãƒ§ãƒ³ç”¨ é€Ÿåº¦é…åˆ— */
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      let b;
      do{ b=getInitialBlock(); }
      while((c>=2 && get(r,c-1)===b && get(r,c-2)===b) || (r>=2 && get(r-1,c)===b && get(r-2,c)===b));
      set(r,c,b);
    }
  }
  currentObstacleCount=0;
  prepareDrop();
}

/* ===== å…¥åŠ›ï¼ˆAï¼‰ ===== */
function getGridPos(x,y){
  const rect=canvas.getBoundingClientRect(), nx=x-rect.left, ny=y-rect.top;
  const scale = logicalSize/rect.width;
  const gc=Math.floor(nx*scale/tileSize), gr=Math.floor(ny*scale/tileSize);
  if(gc<0||gc>=size||gr<0||gr>=size) return null;
  return {r:gr,c:gc};
}
function onStart(x,y){
  userGesture();
  if (paused || animState !== "idle" || swapPair) return;
  const pos=getGridPos(x,y); if(pos){ drag.active=true; drag.start=pos; drag.t={...pos,px:x,py:y}; }
}
function onMove(x,y){
  if(!drag.active || !drag.t) return;
  const rect=canvas.getBoundingClientRect(), scale=logicalSize/rect.width;
  const distSq=(x-drag.t.px)**2+(y-drag.t.py)**2;
  if(distSq<(tileSize*0.35/scale)**2) return;
  const dx=x-drag.t.px, dy=y-drag.t.py;
  let dirX=0, dirY=0;
  if(Math.abs(dx)>Math.abs(dy)) dirX=dx>0?1:-1; else dirY=dy>0?1:-1;
  const {r,c}=drag.start, nr=r+dirY, nc=c+dirX;
  if(nr>=0 && nr<size && nc>=0 && nc<size){
    if (JUSOS.includes(get(r,c)) || JUSOS.includes(get(nr,nc))) return; // â˜…ãŠé‚ªé­”ã¯å‹•ã‹ã•ãªã„
    drag.active=false; swapAndStart(r,c,nr,nc);
  }
}
function onEnd(){ drag.active=false; drag.start=null; drag.t=null; }

/* ===== ãƒ¢ãƒ¼ãƒ‰ãƒ»ä¸€æ™‚åœæ­¢ï¼ˆAï¼‰ ===== */
function setMode(mode){
  isKanki=(mode==='kanki');
  document.getElementById("btnKanki").classList.toggle("active",isKanki);
  document.getElementById("btnShodo").classList.toggle("active",!isKanki);
  updateStatus(`status: ãƒ¢ãƒ¼ãƒ‰ã‚’ã€Œ${isKanki?'æ­“å–œ':'ç„¦åœŸ'}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
}
function togglePause(){ paused=!paused; $pauseBtn.textContent=paused?"â–¶ å†é–‹":"â¸ ä¸€æ™‚åœæ­¢"; if(!paused) gameLoop(); }

/* ===== ãƒãƒƒãƒåˆ¤å®šï½æ¶ˆå»ï¼ˆAãƒ­ã‚¸ãƒƒã‚¯ï¼‹Bã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰ ===== */
let lastMatchVH={v:false,h:false};
function findMatches(checkOnly=true){
  lastMatchVH={v:false,h:false};
  const matches=new Set(); const isBlocked=(b)=> JUSOS.includes(b) || b===null;
  // ç¸¦
  for(let c=0;c<size;c++) for(let r=0;r<=size-3;r++){
    const b=get(r,c); if(isBlocked(b)) continue;
    let len=1; for(let i=r+1;i<size;i++){ if(get(i,c)===b) len++; else break; }
    if(len>=3){ for(let i=0;i<len;i++) matches.add(`${r+i},${c}`); r+=len-1; lastMatchVH.v=true; }
  }
  // æ¨ª
  for(let r=0;r<size;r++) for(let c=0;c<=size-3;c++){
    const b=get(r,c); if(isBlocked(b)) continue;
    let len=1; for(let i=c+1;i<size;i++){ if(get(r,i)===b) len++; else break; }
    if(len>=3){ for(let i=0;i<len;i++) matches.add(`${r},${c+i}`); c+=len-1; lastMatchVH.h=true; }
  }

  if(checkOnly) return matches.size>0;
  if(matches.size>0){
    vanishMask = matches; animState="vanish"; vanishP=0;
    // æ¶ˆå»SEï¼ˆAï¼‰
    Sound.play('pop',1.0);
    if(lastMatchVH.v) Sound.play('vertical', .9);
    if(lastMatchVH.h) Sound.play('horizontal', .9);
    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”Ÿæˆï¼ˆBé¢¨ï¼šæ–¬æ’ƒï¼‹ç²’å­ï¼‰
    createSlashEffects(matches);
    createParticles(matches);
    return true;
  }
  return false;
}

/* ãƒ©ãƒ³ã‚¯é€²æ—ãƒ»ãƒœã‚¤ã‚¹ï¼ˆAï¼‰ */
function updateRank(){
  // Post-top progress handling
  if(rankIndex===MAX_RANK_INDEX){
    if(!maxAchieved && rankProgress>=RANK_THRESH[rankIndex]){
      rankProgress = RANK_THRESH[rankIndex];
      maxAchieved = true; store.set('maxAchieved', true);
      specialPerkUnlocked = true; store.set('specialPerkUnlocked', true);
      try{ Sound.play('bell', 1.0); }catch(_){}
      try{ const v=document.getElementById('vo_rank5'); if(v){ v.volume=1.0; v.play().catch(()=>{}); } }catch(_){}
    }
    if(rankProgress>RANK_THRESH[rankIndex]) rankProgress = RANK_THRESH[rankIndex];
  }

  if(rankIndex<MAX_RANK_INDEX && rankProgress>=RANK_THRESH[rankIndex]){
    rankProgress=0; rankIndex++;
    const v = document.getElementById(`vo_rank${Math.min(rankIndex,4)}`);
    if(v){ try{ v.currentTime=0; v.play().catch(()=>{}); }catch(_){} }
    Sound.play('bell', 1.0); // ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—æ™‚ã€é˜ã‚’åŒæ™‚å†ç”Ÿ
  }
  if(rankIndex>=1 && !unlockedChars.juso_spawn){ unlockedChars.juso_spawn=true; store.set("unlockedChars", unlockedChars); }
  updateScoresUI();
      }

/* æ¶ˆå»â†’è½ä¸‹ï¼ˆAï¼šä¸‹ã¸åœ§ç¸®â†’ä¸Šã‹ã‚‰è£œå……ï¼‰ */
const SEED_BASE_CHANCE = 0.06;

// === ç‰¹æ®Šã‚®ãƒŸãƒƒã‚¯ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
function addCell(set, r, c){
  if(r>=0 && r<size && c>=0 && c<size) set.add(`${r},${c}`);
}
function applySpecialGimmicks(baseMatches){
  const extra = new Set();
  baseMatches.forEach(pos=>{
    const [r,c]=pos.split(',').map(Number);
    const b=get(r,c);
    if(!b || !SPECIALS.includes(b)) return;

    if(b==="S_BIR"){ // ç¸¦åˆ—
      for(let rr=0; rr<size; rr++) addCell(extra, rr, c);
    }
    else if(b==="S_NE0"){ // ç¸¦åˆ— (+ç„¦åœŸã§ä¸¡éš£ã®åˆ—)
      for(let rr=0; rr<size; rr++) addCell(extra, rr, c);
      if(!isKanki){ for(let rr=0; rr<size; rr++){ addCell(extra, rr, c-1); addCell(extra, rr, c+1); } }
    }
    else if(b==="S_SHU"){ // å††å½¢ï¼ˆåŠå¾„2ï¼‰
      for(let rr=r-2; rr<=r+2; rr++) for(let cc=c-2; cc<=c+2; cc++){
        const dx=cc-c, dy=rr-r;
        if(dx*dx+dy*dy<=4) addCell(extra, rr, cc);
      }
    }
    else if(b==="S_REQ"){ // æ¨ªåˆ— (+ç„¦åœŸã§ä¸Šä¸‹ã®è¡Œ)
      for(let cc=0; cc<size; cc++) addCell(extra, r, cc);
      if(!isKanki){ for(let cc=0; cc<size; cc++){ addCell(extra, r-1, cc); addCell(extra, r+1, cc); } }
    }
    else if(b==="S_UNK"){ // æ–œã‚Ã—2
      for(let k=-size; k<=size; k++){
        addCell(extra, r+k, c+k);
        addCell(extra, r+k, c-k);
      }
    }
  });
  return extra;
}

function resolveVanishAndDrop(){
  if(!vanishMask) return;

  // ä»Šå›æ¶ˆãˆãŸç‰¹æ®Šã®ç¨®é¡ã‚’åé›†â†’å°‚ç”¨SE
  const specialsHit = new Set();
  vanishMask.forEach(pos=>{
    const [r,c] = pos.split(',').map(Number);
    const b = get(r,c);
    if (b && SPECIALS.includes(b)) specialsHit.add(b);
  });
  specialsHit.forEach(sym=>{
    if (sym==="S_BIR" || sym==="S_NE0")      Sound.play('vertical', 0.9);
    else if (sym==="S_REQ")                  Sound.play('horizontal', 0.9);
    else if (sym==="S_SHU")                  Sound.play('circle', 1.0);
    else if (sym==="S_UNK")                  Sound.play('cross', 1.0);
  });

  // â‘  ç‰¹æ®Šã‚®ãƒŸãƒƒã‚¯ã§è¿½åŠ ã‚»ãƒ«ã‚’æ‹¡å¼µ
  const extra = applySpecialGimmicks(vanishMask);
  extra.forEach(p=> vanishMask.add(p));
  if (extra.size) { createSlashEffects(extra); createParticles(extra); }

  // â‘¡ ã‚¹ã‚³ã‚¢åŠ ç®—ãƒ»HPå‡¦ç†ãƒ»å®Ÿã‚»ãƒ«æ¶ˆå»
  vanishMask.forEach(pos=>{
    const [r,c]=pos.split(',').map(Number);
    const b=get(r,c);
    if(b){
      score += 10;
      if(SPECIALS.includes(b)){
        score += SPECIAL_POINTS[b];
      }
    }
    // å‘¨å›²ã®ãŠé‚ªé­”ã«ãƒ€ãƒ¡ãƒ¼ã‚¸
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        if(!dr && !dc) continue;
        const tr=r+dr, tc=c+dc;
        if(JUSOS.includes(get(tr,tc)) && jusoHP[tr][tc]>0){
          jusoHP[tr][tc]--;
          if (jusoHP[tr][tc]===0){
            set(tr,tc,null);
            jusoHP[tr][tc] = 0;
            score += 100;
            Sound.play('vertical');
          } else {
            Sound.play('rumble');
          }
        }
      }
    }
    if (JUSOS.includes(b)) {
      /* obstacle: keep until HP zero via adjacency */
    } else {
      set(r,c,null);
    }
  });

// â˜…è¿½åŠ ï¼šã“ã®æ¶ˆå»ã§ä¸€åº¦ã§ã‚‚ç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã€Œå›æ•°ã€ã¨ã—ã¦1åŠ ç®—
  if (specialsHit.size > 0) {
    if(!(rankIndex===MAX_RANK_INDEX && maxAchieved)) rankProgress++;
  }

  // â‘¢ ãƒ©ãƒ³ã‚¯æ›´æ–°ï¼ˆã“ã“ã§ãƒœã‚¤ã‚¹ï¼‹se_bell ãŒé³´ã‚‹å®Ÿè£…æ¸ˆã¿ï¼‰
  const prevRank = rankIndex;
  updateRank();

  // â‘£ ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—æ™‚ï¼šç›¤é¢å…¨æ¶ˆå»ï¼ˆç¸¦ã‚®ãƒŸãƒƒã‚¯æ¼”å‡ºï¼‰
  if(rankIndex > prevRank){
    const all = new Set();
    for(let r=0;r<size;r++){
      for(let c=0;c<size;c++){
        if(get(r,c)!==null) all.add(`${r},${c}`);
      }
    }
    if(all.size>0){
      vanishMask = all;
      animState = "vanish";
      vanishP = 0;
      lastMatchVH.v = true;  // ç¸¦æ–¬æ’ƒã®é›°å›²æ°—
      lastMatchVH.h = false;
      createSlashEffects(all);
      return; // æ¼”å‡ºå¾Œã«å†åº¦ resolve ãŒèµ°ã‚‹
    }
  }

  // â‘¤ é€šå¸¸ã©ãŠã‚Šè½ä¸‹ã¸
  vanishMask = null;
  prepareDrop();
  animState = "drop";
  maybeSpawnObstacles();
}

/* â˜…ã‚¯ãƒƒã‚·ãƒ§ãƒ³è½ä¸‹ç”¨ã®é€Ÿåº¦é…åˆ—ã¨å®šæ•° */
let yVel = [];
const GRAVITY = 0.045; // tileSize å€ã¯æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å‹•çš„ã«åŠ å‘³
const BOUNCE  = 0.25;
const VEL_EPS = 0.6;

function prepareDrop(){
  // ä¸‹åœ§ç¸®
  for(let c=0;c<size;c++){
    let empty=size-1;
    for(let r=size-1;r>=0;r--){
      const b=get(r,c);
      if(b!==null){
        if(r!==empty){
          set(empty,c,b); set(r,c,null);
          if (!jusoHP[empty]) jusoHP[empty] = [];
          if (!jusoHP[r])     jusoHP[r]     = [];
          jusoHP[empty][c] = jusoHP[r][c] || 0;
          jusoHP[r][c] = 0;
          if(!yAnim[empty]) yAnim[empty]=[];
          if(!yVel[empty])  yVel[empty] =[];
          yAnim[empty][c] = -(empty-r)*tileSize;
          yVel[empty][c]  = 0; // â˜…æ–°ä½ç½®ã®é€Ÿåº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
          if(!yVel[r]) yVel[r]=[];
          yVel[r][c]=0;        // â˜…å…ƒä½ç½®ã®é€Ÿåº¦ã‚‚0
        }
        empty--;
      }
    }
  }
  // ä¸Šã‹ã‚‰è£œå……
  for(let c=0;c<size;c++){
    let emptyCount=0;
    for(let r=0;r<size;r++) if(get(r,c)===null) emptyCount++;
    for(let r=0;r<emptyCount;r++){
      let nb=getInitialBlock();
      if(Math.random()<SEED_BASE_CHANCE){
        nb = (specialPerkUnlocked && selectedSpecialOverride)
             ? selectedSpecialOverride
             : SPECIALS[Math.min(rankIndex, SPECIALS.length-1)];
        Sound.play('shine', 0.7);   // ç‰¹æ®Šå‡ºç¾éŸ³
      }
      set(r,c,nb);
      if (!jusoHP[r]) jusoHP[r] = [];
      jusoHP[r][c] = 0;
      if(!yAnim[r]) yAnim[r]=[];
      if(!yVel[r])  yVel[r] =[];
      yAnim[r][c] = -(emptyCount-r)*tileSize;
      yVel[r][c]  = 0; // â˜…æ–°è¦ç”Ÿæˆã‚‚é€Ÿåº¦0ã‹ã‚‰
    }
    for(let r=emptyCount;r<size;r++){
      if(!yAnim[r]) yAnim[r]=[];
      if(!yVel[r])  yVel[r] =[];
      yAnim[r][c] = yAnim[r][c] || 0;
      yVel[r][c]  = yVel[r][c]  || 0;
    }
  }
  Sound.play('whoosh',0.6);
}

/* ãŠé‚ªé­”ç”Ÿæˆï¼ˆAï¼‰ */
function maybeSpawnObstacles(){
  if(rankIndex<1) return;
  if(Math.random()>0.16) return; //ãŠé‚ªé­”ãƒ–ãƒ­ãƒƒã‚¯ã®å‡ºç¾ç‡ã‚’2å€ã«
  const n = 1 + (Math.random()<0.35?1:0);
  let k=0, guard=100;
  while(k<n && guard--){
    const r=Math.floor(Math.random()*size), c=Math.floor(Math.random()*size);
    const cur=get(r,c); if(!cur || JUSOS.includes(cur)) continue;
    const pool = ["J_NEM", "J_SHI", "J_PRO"];
    const pick = pool[Math.floor(Math.random()*pool.length)];
    set(r,c,pick); if(!jusoHP[r]) jusoHP[r]=[]; jusoHP[r][c]=(pick==="J_NEM"?1:(pick==="J_SHI"?2:3)); k++;
  }
}

/* æ–¬æ’ƒï¼†ç²’å­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆBé¢¨å‘³ï¼‰ */
function createSlashEffects(matches){
  slashes=[];
  matches.forEach(p=>{
    const [r,c]=p.split(',').map(Number);
    const cx=c*tileSize+tileSize/2, cy=r*tileSize+tileSize/2;
    slashes.push({x:cx,y:cy,dir:'h',t:0});
    slashes.push({x:cx,y:cy,dir:'v',t:0});
  });
}
function createParticles(matches){
  particles=[];
  matches.forEach(p=>{
    const [r,c]=p.split(',').map(Number);
    const cx=c*tileSize+tileSize/2, cy=r*tileSize+tileSize/2;
    for(let i=0;i<size;i++){
      particles.push({
        x:cx, y:cy,
        vx:(Math.random()-0.5)*tileSize*0.18,
        vy:(Math.random()-0.5)*tileSize*0.18,
        life:0, maxLife:18
      });
    }
  });
}

/* æç”»ï¼ˆç›¤é¢ã¯Aã€BGæ•·ãè©°ã‚ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¯Bè‰²åˆ†ã‘ï¼‰ */
const SWAP_ANIM_TIME=0.15*60, VANISH_ANIM_TIME=0.25*60;
function drawSlashes(){
  if(!slashes.length) return;
  ctx.save();
  // ãƒ¢ãƒ¼ãƒ‰è‰²
  ctx.strokeStyle = isKanki ? "rgba(255,255,255,0.8)" : "rgba(200,40,40,0.85)";
  ctx.globalCompositeOperation='lighter';
  for(const s of slashes){
    const t=Math.min(1,s.t); const len=tileSize*(1+t*1.2); const w=Math.max(2,6-t*5);
    ctx.lineWidth=w; ctx.beginPath();
    if(s.dir==='h'){ ctx.moveTo(s.x-len,s.y); ctx.lineTo(s.x+len,s.y); }
    else{ ctx.moveTo(s.x,s.y-len); ctx.lineTo(s.x,s.y+len); }
    ctx.stroke(); s.t+=0.12;
  }
  slashes=slashes.filter(s=>s.t<1.0); ctx.restore();
}
function drawParticles(){
  if(!particles.length) return;
  ctx.save();
  ctx.globalCompositeOperation='lighter';
  for(const p of particles){
    const t=p.life/p.maxLife;
    const alpha = isKanki ? (0.8*(1-t)) : (0.9*(1-t));
    ctx.fillStyle = isKanki ? `rgba(180,220,255,${alpha})` : `rgba(220,40,40,${alpha})`;
    const rad = Math.max(1, 3 - 2*t);
    ctx.beginPath(); ctx.arc(p.x, p.y, rad, 0, Math.PI*2); ctx.fill();
    p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.life++;
  }
  particles=particles.filter(p=>p.life<p.maxLife);
  ctx.restore();
}

function drawBlock(r,c,x,y,a=1){
  const b=get(r,c); if(b===null) return;
  ctx.save(); ctx.globalAlpha=a;
  const img=IMG[b]; const s=tileSize*0.9, off=tileSize*0.05;
  if(img&&img.complete) ctx.drawImage(img,x+off,y+off,s,s);
  else{ ctx.fillStyle='#444'; ctx.fillRect(x,y,tileSize,tileSize); }
  if (JUSOS.includes(b) && jusoHP[r][c] > 0) {
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.font = `bold ${tileSize * 0.3}px sans-serif`;
    // å³ä¸‹è¡¨ç¤º
    ctx.textAlign = 'right';
    ctx.textBaseline = 'alphabetic';
    const pad = tileSize * 0.08;
    ctx.fillText(jusoHP[r][c], x + tileSize - pad, y + tileSize - pad);
  }
  ctx.restore();
}

function drawGame(){
  ctx.clearRect(0,0,logicalSize,logicalSize);
  // BGï¼ˆAã®é§’æ å¼çˆªï¼‰æ•·ãè©°ã‚
  const bg=IMG.BG; if(bg&&bg.complete&&bg.naturalWidth>0){
    for(let r=0;r<size;r++) for(let c=0;c<size;c++){
      ctx.drawImage(bg,0,0,bg.naturalWidth,bg.naturalHeight,c*tileSize,r*tileSize,tileSize,tileSize);
    }
  }
  // ç„¦åœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè–„èµ¤é»’ï¼‰
  if(!isKanki){ ctx.save(); ctx.fillStyle='rgba(60,0,0,0.22)'; ctx.fillRect(0,0,logicalSize,logicalSize); ctx.restore(); }

  for(let r=0;r<size;r++) for(let c=0;c<size;c++){
    if(get(r,c)===null) continue;
    let x=c*tileSize, y=r*tileSize, a=1, ty=0;
    if(animState==="vanish" && vanishMask && vanishMask.has(`${r},${c}`)) a = 1-vanishP;
    if(animState==="drop" && yAnim[r][c]!==0) ty = yAnim[r][c];
    if(animState==="swap" && swapPair){
      const {p1,p2,p,back}=swapPair; const prog=Math.min(1,p/(SWAP_ANIM_TIME)), e=Math.sin(prog*Math.PI/2);
      if(r===p1.r&&c===p1.c){ x+=(back?(p2.c-p1.c)*tileSize*(1-e):(p2.c-p1.c)*tileSize*e);
                               y+=(back?(p2.r-p1.r)*tileSize*(1-e):(p2.r-p1.r)*tileSize*e); }
      if(r===p2.r&&c===p2.c){ x+=(back?(p1.c-p2.c)*tileSize*(1-e):(p1.c-p2.c)*tileSize*e);
                               y+=(back?(p1.r-p2.r)*tileSize*(1-e):(p1.r-p2.r)*tileSize*e); }
    }
    drawBlock(r,c,x,y+ty,a);
  }
  // Bé¢¨ï¼šæ–¬æ’ƒï¼†ç²’å­
  drawSlashes();
  drawParticles();

  // å‰é¢ã‚¹ãƒ¯ãƒƒãƒ—ï¼ˆAï¼‰
  if(animState==="swap" && swapPair){
    const {p1,p2,p,back}=swapPair; const prog=Math.min(1,p/(SWAP_ANIM_TIME)), e=Math.sin(prog*Math.PI/2);
    let x1=p1.c*tileSize+(back?(p2.c-p1.c)*tileSize*(1-e):(p2.c-p1.c)*tileSize*e);
    let y1=p1.r*tileSize+(back?(p2.r-p1.r)*tileSize*(1-e):(p2.r-p1.r)*tileSize*e);
    drawBlock(p1.r,p1.c,x1,y1,1);
    let x2=p2.c*tileSize+(back?(p1.c-p2.c)*tileSize*(1-e):(p1.c-p2.c)*tileSize*e);
    let y2=p2.r*tileSize+(back?(p1.r-p2.r)*tileSize*(1-e):(p1.r-p2.r)*tileSize*e);
    drawBlock(p2.r,p2.c,x2,y2,1);
  }
}

/* ã‚¹ãƒ¯ãƒƒãƒ—ï½ãƒ«ãƒ¼ãƒ—ï¼ˆAï¼‰ */
function canSwapAndMatch(r1,c1,r2,c2){
  if(JUSOS.includes(get(r1,c1))||JUSOS.includes(get(r2,c2))) return false;
  swap(r1,c1,r2,c2);
  const has = !!findMatches(true);
  swap(r1,c1,r2,c2);
  return has;
}
function swapAndStart(r1,c1,r2,c2){
  swapPair={p1:{r:r1,c:c1},p2:{r:r2,c:c2},p:0,back:false};
  animState="swap";
  userGesture();
}
function gameLoop(){
  if(paused) return;
  drawGame();
  switch(animState){
    case "swap":
      if(swapPair){
        swapPair.p++;
        if(swapPair.p>=SWAP_ANIM_TIME){
          const {p1,p2,back}=swapPair;
          if(!back){
            swap(p1.r,p1.c,p2.r,p2.c);
            if(findMatches(true)){ findMatches(false); swapPair=null; animState="vanish"; }
            else{ swap(p1.r,p1.c,p2.r,p2.c); swapPair.p=0; swapPair.back=true; }
          }else{ swapPair=null; animState="idle"; }
        }
      }
      break;
    case "vanish":
      vanishP += (1/VANISH_ANIM_TIME); if(vanishP>=1){ resolveVanishAndDrop(); }
      break;
    case "drop":
      // â˜…ã‚¯ãƒƒã‚·ãƒ§ãƒ³è½ä¸‹ï¼šé‡åŠ›ï¼‹å¼±ã„åç™ºã§ã‚„ã‚ã‚‰ã‹ãåœæ­¢
      let done=true;
      for(let r=0;r<size;r++) for(let c=0;c<size;c++){
        if(yAnim[r][c]!==0 || yVel[r][c]!==0){
          const g = GRAVITY*tileSize;     // ç›¤é¢ã‚µã‚¤ã‚ºã«ä¾å­˜ã•ã›ã‚‹
      yVel[r][c] += g;          // åŠ é€Ÿ
      yVel[r][c] *= 0.88;       // â˜…æ¸›è¡°ã§ãµã‚ã£ã¨
      // ã‚ªãƒ¼ãƒãƒ¼ã‚·ãƒ¥ãƒ¼ãƒˆã•ã›ãšã«ãã®ã¾ã¾ç€åœ°
      if (yAnim[r][c] + yVel[r][c] >= 0){
        yAnim[r][c] = 0;
        yVel[r][c]  = 0;
      } else {
        yAnim[r][c] += yVel[r][c];
      }
          if(yAnim[r][c]!==0 || yVel[r][c]!==0) done=false;
        }
      }
      if(done){
        if(findMatches(true)){ findMatches(false); animState="vanish"; }
        else { animState="idle"; }
      }
      break;
  }
  requestAnimationFrame(gameLoop);
}

/* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆAï¼šæ‰‹å‹•ã®ã¿ï¼‰ */
function hasPossibleMoves(){
  for(let r=0;r<size;r++) for(let c=0;c<size;c++){
    if(c+1<size && canSwapAndMatch(r,c,r,c+1)) return true;
    if(r+1<size && canSwapAndMatch(r,c,r+1,c)) return true;
  }
  return false;
}
function shuffleBoard(){
  const maxTries=300; let tries=0;
  do{
    const flat=board.flat(); for(let i=flat.length-1;i>0;i++){ const j=Math.floor(Math.random()*(i+1)); [flat[i],flat[j]]=[flat[j],flat[i]]; }
    for(let r=0,k=0;r<size;r++) for(let c=0;c<size;c++,k++) board[r][c]=flat[k];
    tries++;
  }while((findMatches(true)||!hasPossibleMoves()) && tries<maxTries);
  updateStatus("status: ç›¤é¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸã€‚");
  animState="drop"; prepareDrop();
}

/* èµ·å‹•ï¼ˆAï¼‰ */
function initGame(reset=false){
const parentW = 480;                      // â˜…å›ºå®šã‚µã‚¤ã‚ºã«
  logicalSize = Math.floor(480/size)*size;  // â˜…ç›¤é¢ãƒ­ã‚¸ãƒƒã‚¯ã‚‚å›ºå®š
  tileSize = logicalSize/size;
  DPR=Math.max(1,Math.min(3,Math.floor(window.devicePixelRatio||1)));
  canvas.width=logicalSize*DPR; canvas.height=logicalSize*DPR; ctx.setTransform(1,0,0,1,0,0); ctx.scale(DPR,DPR);
  canvas.style.width = '100%'; canvas.style.height = 'auto';
  if(reset) initBoard();
  updateScoresUI();
      setMode('kanki');
  if(!reset) gameLoop();
}
function startUp(){ loadImages(()=>{ initGame(true); updateStatus("status: game loaded. ready to play."); gameLoop(); }); }

/* ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆAã®ã¾ã¾ã€‚ãƒœã‚¿ãƒ³SEã¯ se_push ã«çµ±ä¸€ï¼‰ */
const onClickSE = ()=>Sound.play('push', .9);
canvas.addEventListener('mousedown',e=>onStart(e.clientX,e.clientY));
canvas.addEventListener('mousemove',e=>onMove(e.clientX,e.clientY));
canvas.addEventListener('mouseup',onEnd);
canvas.addEventListener('mouseleave',onEnd);
canvas.addEventListener('touchstart',e=>{ e.preventDefault(); onStart(e.touches[0].clientX,e.touches[0].clientY); });
canvas.addEventListener('touchmove',e=>{ e.preventDefault(); onMove(e.touches[0].clientX,e.touches[0].clientY); });
canvas.addEventListener('touchend',onEnd);

document.getElementById("btnCharIntro").addEventListener('click', ()=>{ onClickSE(); openCharModal(); });
document.querySelectorAll('.btn').forEach(b=>{
  if(b.id!=="shuffleBtn"){ b.addEventListener('click', onClickSE); }
});
bgmSel1.addEventListener('click', ()=>selectBGM(1));
bgmSel2.addEventListener('click', ()=>selectBGM(2));

window.addEventListener('beforeunload', ()=>{
  store.set("score",score); store.set("rankIndex",rankIndex); store.set("rankProgress",rankProgress);
});

startUp();
</script>
  <audio id="vo_reverse" src="audio/vo_reverse.mp3" preload="auto"></audio>
  <audio id="vo_rank5" src="audio/vo_rank5.mp3" preload="auto"></audio>

<div id="maxResetBtn" title="MAXã‚’ãƒªãƒãƒ¼ã‚¹">â†º</div>
<div id="maxResetConfirm" role="dialog" aria-modal="true">
  <div class="panel">
    <div class="title">ä¿®ç¾…ç‹ä¸¸ã®è¦šé†’ãƒ©ãƒ³ã‚¯ã‚’ãƒªãƒãƒ¼ã‚¹ã—ã¾ã™ã‹</div>
    <div class="cmds">
      <button id="maxResetNo">ã„ã„ãˆ</button>
      <button id="maxResetYes" class="primary">ã¯ã„</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $btn = document.getElementById('maxResetBtn');
  const $dlg = document.getElementById('maxResetConfirm');
  const $yes = document.getElementById('maxResetYes');
  const $no  = document.getElementById('maxResetNo');
  function gateMaxResetBtn(){
    if(!$btn) return;
    if(typeof rankIndex!=='undefined' && typeof MAX_RANK_INDEX!=='undefined' && typeof maxAchieved!=='undefined'){
      $btn.style.display = (rankIndex===MAX_RANK_INDEX && maxAchieved) ? '' : 'none';
    }
  }
  if($btn){ $btn.addEventListener('click', ()=>{ if($dlg) $dlg.style.display='flex'; }); }
  if($no){ $no.addEventListener('click', ()=>{ if($dlg) $dlg.style.display='none'; }); }
  if($yes){
    $yes.addEventListener('click', ()=>{
      try{
        maxAchieved = false; if(store&&store.set){ store.set('maxAchieved', false); }
        rankIndex = 0; rankProgress = 0;
        if(store&&store.set){ store.set('rankIndex',0); store.set('rankProgress',0); }
        updateScoresUI();
        try{ const v=document.getElementById('vo_reverse'); if(v){ v.currentTime=0; v.volume=1.0; v.play().catch(()=>{}); } }catch(_){}
      try{ Sound.play('cancel', 0.8); }catch(_){}
        }catch(e){}
      if($dlg) $dlg.style.display='none';
      gateMaxResetBtn();
    });
  }
  window.__gateMaxResetBtn = gateMaxResetBtn;
})();</script>
</body>
</html>
